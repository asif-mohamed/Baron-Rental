generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ========== AUTH & RBAC ==========

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  fullName  String
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  roleId String
  role   Role   @relation(fields: [roleId], references: [id])

  bookings            Booking[]
  transactions        Transaction[]
  maintenanceRecords  MaintenanceRecord[]
  inventoryMovements  InventoryMovement[]
  activityLogs        ActivityLog[]
  notifications       Notification[]      @relation("ReceivedNotifications")
  sentNotifications   Notification[]      @relation("SentNotifications")
  businessPlans       BusinessPlan[]

  @@map("users")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique // Admin, Manager, Reception, Warehouse, Accountant, Mechanic
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  resource    String   // cars, customers, bookings, transactions, etc.
  action      String   // create, read, update, delete
  description String?
  createdAt   DateTime @default(now())

  roles RolePermission[]

  @@unique([resource, action])
  @@map("permissions")
}

model RolePermission {
  id           String   @id @default(uuid())
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

// ========== FLEET MANAGEMENT ==========

model Car {
  id                 String    @id @default(uuid())
  brand              String
  model              String
  year               Int
  plateNumber        String    @unique
  color              String
  vin                String?   @unique
  dailyRate          Float
  mileage            Int       @default(0)
  status             String    @default("available") // available, rented, maintenance, sold
  condition          String    @default("excellent") // excellent, good, fair, poor
  fuelType           String?   // petrol, diesel, electric, hybrid
  transmission       String?   // automatic, manual
  seats              Int       @default(5)
  category           String?   // economy, compact, suv, luxury
  purchaseDate       DateTime?
  purchasePrice      Float?
  notes              String?
  isDeleted          Boolean   @default(false)
  deletedAt          DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  maintenanceProfileId String?
  maintenanceProfile   MaintenanceProfile? @relation(fields: [maintenanceProfileId], references: [id])

  bookings           Booking[]
  maintenanceRecords MaintenanceRecord[]
  attachments        Attachment[]
  inventoryMovements InventoryMovement[]

  @@map("cars")
}

model MaintenanceProfile {
  id                    String   @id @default(uuid())
  name                  String
  mileageThreshold      Int?     // trigger maintenance every X km
  daysThreshold         Int?     // trigger maintenance every X days
  description           String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  cars Car[]

  @@map("maintenance_profiles")
}

// ========== CUSTOMERS ==========

model Customer {
  id              String    @id @default(uuid())
  fullName        String
  email           String?
  phone           String
  address         String?
  licenseNumber   String?
  licenseExpiry   DateTime?
  nationalId      String?
  nationalIdDocument String? // Path to uploaded ID scan
  fingerprintDocument String? // Path to uploaded fingerprint scan
  rentalContract  String? // Path to uploaded rental contract
  dateOfBirth     DateTime?
  notes           String?
  isDeleted       Boolean   @default(false)
  deletedAt       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  bookings    Booking[]
  attachments Attachment[]

  @@map("customers")
}

// ========== BOOKINGS ==========

model Booking {
  id              String    @id @default(uuid())
  bookingNumber   String    @unique
  carId           String
  customerId      String
  userId          String    // who created the booking
  startDate       DateTime
  endDate         DateTime
  pickupDate      DateTime?
  returnDate      DateTime?
  totalDays       Int
  dailyRate       Float
  subtotal        Float
  extras          Float     @default(0)
  taxes           Float     @default(0)
  discount        Float     @default(0)
  totalAmount     Float
  paidAmount      Float     @default(0)
  initialOdometer Int?      // Odometer reading at pickup
  finalOdometer   Int?      // Odometer reading at return
  status          String    @default("pending") // pending, confirmed, active, completed, cancelled
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  car          Car           @relation(fields: [carId], references: [id])
  customer     Customer      @relation(fields: [customerId], references: [id])
  user         User          @relation(fields: [userId], references: [id])
  transactions Transaction[]
  attachments  Attachment[]

  @@map("bookings")
}

// ========== TRANSACTIONS ==========

model Transaction {
  id              String   @id @default(uuid())
  bookingId       String?
  userId          String
  type            String   // payment, refund, expense, income
  category        String?  // rental, maintenance, fuel, insurance, other
  amount          Float
  paymentMethod   String?  // cash, card, transfer, cheque
  referenceNumber String?
  description     String?
  transactionDate DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  booking     Booking?     @relation(fields: [bookingId], references: [id])
  user        User         @relation(fields: [userId], references: [id])
  attachments Attachment[]

  @@map("transactions")
}

// ========== MAINTENANCE ==========

model MaintenanceRecord {
  id               String    @id @default(uuid())
  carId            String
  userId           String
  type             String    // routine, repair, inspection, upgrade
  description      String
  cost             Float     @default(0)
  mileageAtService Int?
  serviceDate      DateTime
  nextServiceDate  DateTime?
  status           String    @default("scheduled") // scheduled, in-progress, completed, cancelled
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  car         Car          @relation(fields: [carId], references: [id])
  user        User         @relation(fields: [userId], references: [id])
  attachments Attachment[]

  @@map("maintenance_records")
}

// ========== INVENTORY & MOVEMENTS ==========

model InventoryMovement {
  id          String   @id @default(uuid())
  carId       String
  userId      String
  type        String   // purchase, sale, transfer, write-off
  quantity    Int      @default(1)
  amount      Float?
  description String?
  movementDate DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  car  Car  @relation(fields: [carId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@map("inventory_movements")
}

// ========== ATTACHMENTS ==========

model Attachment {
  id            String    @id @default(uuid())
  fileName      String
  originalName  String
  fileSize      Int
  mimeType      String
  filePath      String
  entityType    String    // car, customer, booking, transaction, maintenance
  entityId      String
  uploadedById  String?
  createdAt     DateTime  @default(now())

  car         Car?               @relation(fields: [entityId], references: [id])
  customer    Customer?          @relation(fields: [entityId], references: [id])
  booking     Booking?           @relation(fields: [entityId], references: [id])
  transaction Transaction?       @relation(fields: [entityId], references: [id])
  maintenance MaintenanceRecord? @relation(fields: [entityId], references: [id])

  @@map("attachments")
}

// ========== NOTIFICATIONS ==========

model Notification {
  id              String   @id @default(uuid())
  userId          String?  // Recipient user ID
  roleId          String?  // For role-based notifications (e.g., all Warehouse managers)
  senderId        String?  // User who sent the notification (for user-to-user messages)
  type            String   // booking_created, pickup_due, overdue, maintenance_due, car_pickup_needed, user_message
  title           String
  message         String
  data            String?  // JSON data
  isRead          Boolean  @default(false)
  requiresAction  Boolean  @default(false)
  actionType      String?  // approve, extend, confirm, acknowledge
  createdAt       DateTime @default(now())

  user   User? @relation("ReceivedNotifications", fields: [userId], references: [id])
  sender User? @relation("SentNotifications", fields: [senderId], references: [id])

  @@map("notifications")
}

// ========== ACTIVITY LOGS ==========

model ActivityLog {
  id          String   @id @default(uuid())
  userId      String
  action      String   // create, update, delete, login, logout
  entityType  String?  // car, customer, booking, etc.
  entityId    String?
  details     String?  // JSON details
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@map("activity_logs")
}

// ========== BUSINESS PLANS ==========

model BusinessPlan {
  id           String   @id @default(uuid())
  userId       String
  title        String
  type         String   // improvement, expansion, financial, marketing, operational, strategic
  priority     String   // low, medium, high, critical
  status       String   // draft, active, completed, cancelled
  description  String
  startDate    String
  endDate      String
  budget       Float?
  assignedTo   String?
  employeeId   String?
  employeeName String?
  goals        String   // JSON array of goals
  tasks        String   // JSON array of tasks
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@map("business_plans")
}
